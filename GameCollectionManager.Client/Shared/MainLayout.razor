@using Microsoft.AspNetCore.Components.Authorization
@using GameCollectionManager.Client.Auth
@using System.Security.Claims
@using System.IdentityModel.Tokens.Jwt
@inherits LayoutComponentBase
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject HttpClient HttpClient
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4 auth-controls">
            <MudIconButton Icon="@Icons.Material.Filled.Home" Color="Color.Inherit" OnClick="HandleHome" />
            <AuthorizeView>
                <Authorized>
                    <MudButton Variant="Variant.Text" Color="Color.Inherit" OnClick="HandleUpload">
                        Upload Collection
                    </MudButton>
                    <span>Welcome, @GetUsername(context.User)!</span>
                    <MudButton Variant="Variant.Text" Color="Color.Inherit" OnClick="HandleLogout">
                        Logout
                    </MudButton>
                </Authorized>
                <NotAuthorized>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="HandleLogin">
                        Login with Discord
                    </MudButton>
                </NotAuthorized>
            </AuthorizeView>
            <MudIconButton Icon="@Icons.Custom.Brands.GitHub" Color="Color.Inherit" href="https://github.com/Saious119/Game-Collection-Manager-API" />
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

@* Required *@
<MudThemeProvider />
<MudPopoverProvider />

@* Needed for dialogs *@
<MudDialogProvider />

@* Needed for snackbars *@
<MudSnackbarProvider />

@code {
    private async Task HandleLogin()
    {
        // Get the Discord OAuth URL from the server
        var response = await HttpClient.GetAsync("api/auth/discord/login");
        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadFromJsonAsync<DiscordLoginResponse>();
            if (result?.AuthUrl != null)
            {
                // Redirect to Discord OAuth page
                await JSRuntime.InvokeVoidAsync("open", result.AuthUrl, "_self");
            }
        }
    }

    private async Task HandleLogout()
    {
        if (AuthenticationStateProvider is CustomAuthStateProviderV2 provider)
        {
            await provider.MarkUserAsLoggedOut();
        }
    }

    private void HandleHome() => NavigationManager.NavigateTo("/");

    private async Task HandleUpload() => NavigationManager.NavigateTo("/upload");

    private string GetUsername(ClaimsPrincipal user)
    {
        // Try to get username from UniqueName claim (JWT standard)
        var username = user.FindFirst(JwtRegisteredClaimNames.UniqueName)?.Value;
        
        // Fallback to Name claim
        if (string.IsNullOrEmpty(username))
            username = user.Identity?.Name;
            
        return username ?? "User";
    }

    private class DiscordLoginResponse
    {
        public string AuthUrl { get; set; } = "";
    }
}