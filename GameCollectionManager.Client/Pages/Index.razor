@page "/"
@using GameCollectionManager.Client.Shared
@using GameCollectionManager.Shared.Models
@using static MudBlazor.CategoryTypes
@using System.Net.Http.Json
@using Newtonsoft.Json
@using MudBlazor
@using MudBlazor.Extensions
@using System.Security.Claims
@using System.IdentityModel.Tokens.Jwt
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Game Collection</PageTitle>

<MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
    <MudTabPanel Text="Games">
        <MudDataGrid Items="@games" Dense="true" Hover="true" Bordered="true" Striped="true" 
            QuickFilter="@QuickFilter">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Games Collection</MudText>
                <MudSpacer />
                <MudTextField @bind-Value="searchString" 
                            Placeholder="Search" 
                            Adornment="Adornment.Start"
                            AdornmentIcon="@Icons.Material.Filled.Search" 
                            IconSize="Size.Medium" 
                            Class="mt-0 ml-4"
                            Immediate="true"
                            @bind-Value:after="@(() => InvokeAsync(StateHasChanged))" />
                <MudSpacer />
                <MudButton Color="Color.Primary"
                           Variant="Variant.Filled"
                           OnClick="OpenAddGameDialog"
                           StartIcon="@Icons.Material.Filled.Add">
                    Add Game
                </MudButton>
            </ToolBarContent>
            <Columns>
				<PropertyColumn Property="x => x.name" Title="Title" />
                <PropertyColumn Property="x => GetFirstPlatformName(x)" Title="Platform" />
                <PropertyColumn Property="x => GetFirstReleaseDate(x)" Title="Release Date" />
                <PropertyColumn Property="x => x.aggregatedrating" Title="Rating" />
                <PropertyColumn Property="x => x.genres" Title="Genres" />
                <PropertyColumn Property="x => x.status" Title="Status">
                    <CellTemplate Context="gameContext">
                        <MudSelect T="string" 
                                  Value="@(((GameDAO)gameContext.Item).status)" 
                                  ValueChanged="@(async (string value) => await UpdateGameStatus((GameDAO)gameContext.Item, value))"
                                  Dense="true"
                                  Margin="Margin.Dense"
                                  OffsetY="true">
                            @foreach(var status in gameStatuses)
                            {
                                <MudSelectItem Value="@status">@status</MudSelectItem>
                            }
                        </MudSelect>
                    </CellTemplate>
                </PropertyColumn>
                <TemplateColumn Title="Actions">
                    <CellTemplate Context="gameContext">
                        <div class="d-flex gap-2">  @* This creates a flex container with gap between buttons *@
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Primary" 
                                      Size="Size.Small"
                                      OnClick="@(() => AddToQueue((GameDAO)gameContext.Item))"
                                      Disabled="@(((GameDAO)gameContext.Item).queuepos != null || _processing)"
                                      Loading="@(_processingId == ((GameDAO)gameContext.Item).id)"
                                      Class="fixed-width-button"> 
                                @if (_processingId == ((GameDAO)gameContext.Item).id)
                                {
                                    <span>Adding...</span>
                                }
                                else if(((GameDAO)gameContext.Item).queuepos != null)
                                {
                                    <span>In Queue</span>
								}
                                else
                                {
                                    <span>Add to Queue</span>
                                }
                            </MudButton>

                            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                      Variant="Variant.Filled" 
                                      Color="Color.Info" 
                                      Size="Size.Small"
                                      aria-label="edit"
                                      OnClick="@(async () => await OpenEditGameDialog((GameDAO)gameContext.Item))">
                            </MudIconButton>

                            <MudIconButton Icon="@Icons.Material.Filled.DeleteForever" 
                                      Variant="Variant.Filled" 
                                      Color="Color.Error" 
                                      Size="Size.Small"
                                      aria-label="delete"
                                      OnClick="@(async () => await DeleteGameWithConfirmation((GameDAO)gameContext.Item))"
                                      Loading="@(_deletingId == ((GameDAO)gameContext.Item).id)">
                                @if (_deletingId == ((GameDAO)gameContext.Item).id)
                                {
                                    <span>Deleting...</span>
                                }
                                else
                                {
                                    <span>Delete</span>
                                }
                            </MudIconButton>
                        </div>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    </MudTabPanel>

    <MudTabPanel Text="Queue">
        <MudDataGrid Items="@queueGames" 
                     Dense="true" 
                     Hover="true" 
                     Bordered="true" 
                     Striped="true"
                     QuickFilter="@QuickQueueFilter"
                     RowsDraggable="true"
                     DragDropColumn="0"
                     RowDrop="OnRowDrop">  @* Changed to RowDrop *@
            <ToolBarContent>
                <MudText Typo="Typo.h6">Game Queue</MudText>
                <MudSpacer />
                <MudTextField @bind-Value="queueSearchString" 
                             Placeholder="Search" 
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.Search" 
                             IconSize="Size.Medium" 
                             Class="mt-0"
                             Immediate="true"
                             @bind-Value:after="@(() => InvokeAsync(StateHasChanged))" />
            </ToolBarContent>
            <Columns>
                <PropertyColumn Property="x => x.queuepos" Title="#" />
                <PropertyColumn Property="x => x.name" Title="Title" />
                <PropertyColumn Property="x => GetFirstPlatformName(x)" Title="Platform" />
                <PropertyColumn Property="x => GetFirstReleaseDate(x)" Title="Release Date" />
                <PropertyColumn Property="x => x.aggregatedrating" Title="Rating" />
                <PropertyColumn Property="x => x.status" Title="Status">
                    <CellTemplate Context="gameContext">
                        <MudSelect T="string" 
                                  Value="@(((GameDAO)gameContext.Item).status)" 
                                  ValueChanged="@(async (string value) => await UpdateGameStatus((GameDAO)gameContext.Item, value))"
                                  Dense="true"
                                  Margin="Margin.Dense"
                                  OffsetY="true">
                            @foreach(var status in gameStatuses)
                            {
                                <MudSelectItem Value="@status">@status</MudSelectItem>
                            }
                        </MudSelect>
                    </CellTemplate>
                </PropertyColumn>
                <TemplateColumn Title="Actions">
                    <CellTemplate Context="gameContext">
                        <div class="d-flex gap-2">
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Primary" 
                                      Size="Size.Small"
                                      OnClick="@(() => RemoveFromQueue((GameDAO)gameContext.Item))"
                                      Disabled="@(((GameDAO)gameContext.Item).queuepos == null || _processing)"
                                      Loading="@(_processingId == ((GameDAO)gameContext.Item).id)"
                                      Class="fixed-width-queue-button">
                                @if (_processingId == ((GameDAO)gameContext.Item).id)
                                {
                                    <span>Removing...</span>
                                }
                                else
                                {
                                    <span>Remove From Queue</span>
                                }
                            </MudButton>

                            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                      Variant="Variant.Filled" 
                                      Color="Color.Info" 
                                      Size="Size.Small"
                                      aria-label="edit"
                                      OnClick="@(async () => await OpenEditGameDialog((GameDAO)gameContext.Item))">
                            </MudIconButton>
                        </div>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    </MudTabPanel>
</MudTabs>

<style>
    .mud-grid-item.mud-dragging {
        background-color: var(--mud-palette-background-grey);
        opacity: 0.8;
    }

    .fixed-width-button {
        width: 130px;  /* Adjust this value based on your needs */
    }
    .fixed-width-queue-button {
        width: 170px;
    }
</style>

@code {
    private string searchString = "";
    private string queueSearchString = "";
    private List<GameDAO> games = new();
    private List<GameDAO> queueGames = new();
    private List<string> gameStatuses = new List<string>
    {
        "Not Started",
        "Playing",
        "Completed",
        "Dropped"
    };

    private bool _processing = false;
    private int _processingId = -1;
    private int _deletingId = -1;

    private string? user;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var AuthUser = authState.User;
        user = AuthUser.FindFirst(System.IdentityModel.Tokens.Jwt.JwtRegisteredClaimNames.UniqueName)?.Value
                          ?? AuthUser.Identity?.Name;
        
        // If you want to use username instead, use this:
        // user = authState.User.FindFirst(JwtRegisteredClaimNames.UniqueName)?.Value;
        
        if (string.IsNullOrEmpty(user))
        {
            user = "unknown";
        }

        await LoadGames();
    }

    private async Task LoadGames()
    {
        try
        {
            var response = await Http.GetStringAsync($"api/GameCollection/GetCollection/{user}");

            if (!string.IsNullOrEmpty(response))
            {
                try
                {

                    games = JsonConvert.DeserializeObject<List<GameDAO>>(response) ?? new();
                    queueGames = games.Where(g => g.queuepos != null)
                                    .OrderBy(g => g.queuepos)
                                    .ToList();
                }
                catch (JsonException jsonEx)
                {
                    Console.WriteLine($"JSON Deserialization error: {jsonEx.Message}");
                    Console.WriteLine($"Response content: {response}");
                }
            }
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"HTTP Request error: {ex.Message}");
            games = new();
            queueGames = new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading games: {ex.Message}");
            games = new();
            queueGames = new();
        }
    }

    // Add methods for CRUD operations
    private async Task AddGame(GameDAO game)
    {
        try
        {
            game.owner = user;
            game.status = "Not Started";
            var response = await Http.PostAsJsonAsync($"api/GameCollection/AddNewGame?user={user}", game);
            if (response.IsSuccessStatusCode)
            {
                await OnInitializedAsync();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error response: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding game: {ex.Message}");
        }
    }

    private async Task DeleteGame(GameDAO game)
    {
        try
        {
            var response = await Http.PostAsJsonAsync($"api/GameCollection/DeleteGame?user={user}", game);
            if (response.IsSuccessStatusCode)
            {
                await OnInitializedAsync();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error response: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting game: {ex.Message}");
        }
    }


    private async Task AddToQueue(GameDAO game)
    {
        try
        {
            _processing = true;
            _processingId = game.id;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync($"api/GameCollection/AddToQueue?user={user}", game);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"{game.name} added to queue", Severity.Success);
                await OnInitializedAsync();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error response: {error}");
                Snackbar.Add($"Failed to add {game.name} to queue", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding game to queue: {ex.Message}");
            Snackbar.Add($"Error adding game to queue: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
            _processingId = -1;
            StateHasChanged();
        }
    }

    private async Task RemoveFromQueue(GameDAO game)
    {
        try
        {
            _processing = true;
            _processingId = game.id;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync($"api/GameCollection/RemoveFromQueue?user={user}", game);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"{game.name} Removed from queue", Severity.Success);
                await OnInitializedAsync();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error response: {error}");
                Snackbar.Add($"Failed to remove {game.name} from queue", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error removing from queue: {ex.Message}");
            Snackbar.Add($"Error removing game from queue: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
            _processingId = -1;
            StateHasChanged();
        }
    }

    private async Task OpenAddGameDialog()
    {
        try
        {
            var parameters = new DialogParameters();
            var dialog = await DialogService.ShowAsync<AddGameDialog>("Add New Game", parameters);
            var result = await dialog.Result;

            if (!result.Canceled)
            {
                Console.WriteLine($"Dialog result: {JsonConvert.SerializeObject(result.Data)}");
                if (result.Data is GameDAO gameDao)
                {
                    await AddGame(gameDao);
                    Snackbar.Add($"Added {gameDao.name} to collection", Severity.Success);
                }
                else
                {
                    Console.WriteLine($"Unexpected data type: {result.Data?.GetType().FullName}");
                    Snackbar.Add("Error: Invalid game data received", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in OpenAddGameDialog: {ex}");
            Snackbar.Add("Error adding game", Severity.Error);
        }
    }

    private async Task OpenEditGameDialog(GameDAO game)
    {
        try
        {
            var parameters = new DialogParameters
            {
                { "Game", game }
            };
            
            var dialog = await DialogService.ShowAsync<EditGameDialog>("Edit Game", parameters);
            var result = await dialog.Result;

            if (!result.Canceled)
            {
                Console.WriteLine($"Dialog result: {JsonConvert.SerializeObject(result.Data)}");
                if (result.Data is GameDAO editedGame)
                {
                    editedGame.owner = user;
                    var response = await Http.PostAsJsonAsync($"api/GameCollection/AddNewGame?user={user}", editedGame);
                    
                    if (response.IsSuccessStatusCode)
                    {
                        Snackbar.Add($"Updated {editedGame.name} successfully", Severity.Success);
                        await OnInitializedAsync();
                    }
                    else
                    {
                        var error = await response.Content.ReadAsStringAsync();
                        Console.WriteLine($"Error response: {error}");
                        Snackbar.Add("Failed to update game", Severity.Error);
                    }
                }
                else
                {
                    Console.WriteLine($"Unexpected data type: {result.Data?.GetType().FullName}");
                    Snackbar.Add("Error: Invalid game data received", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in OpenEditGameDialog: {ex}");
            Snackbar.Add("Error editing game", Severity.Error);
        }
    }

    private string GetFirstPlatformName(GameDAO game)
    {
        try
        {
            string gameAsText = JsonConvert.SerializeObject(game);
            return game?.platforms ?? string.Empty;
        }
        catch
        {
            return string.Empty;
        }
    }

    private string GetFirstReleaseDate(GameDAO game)
    {
        try
        {
            return game?.releasedates ?? string.Empty;
        }
        catch
        {
            return string.Empty;
        }
    }

    private async Task DeleteGameWithConfirmation(GameDAO game)
    {
        bool? result = await DialogService.ShowMessageBox(
        "Delete Game",
        $"Are you sure you want to delete {game.name}?",
        yesText: "Delete",
        cancelText: "Cancel",
        options: new DialogOptions { CloseOnEscapeKey = true });

        if (result == true)
        {
            try
            {
                _deletingId = game.id;
                StateHasChanged();

                await RemoveFromQueue(game);

                var response = await Http.PostAsJsonAsync($"api/GameCollection/DeleteGame?user={user}", game);
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add($"{game.name} deleted successfully", Severity.Success);
                    await OnInitializedAsync();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"Error response: {error}");
                    Snackbar.Add($"Failed to delete {game.name}", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting game: {ex.Message}");
                Snackbar.Add($"Error deleting game: {ex.Message}", Severity.Error);
            }
            finally
            {
                _deletingId = -1;
                StateHasChanged();
            }
        }
    }

    private Func<GameDAO, bool> QuickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;

        if (x.name != null && x.name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    };

    private Func<GameDAO, bool> QuickQueueFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(queueSearchString))
            return true;

        if (x.name != null && x.name.Contains(queueSearchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    };

    private async Task UpdateGameStatus(GameDAO game, string newStatus)
    {
        try
        {
            game.status = newStatus;
            var response = await Http.PostAsJsonAsync($"api/GameCollection/AddNewGame?user={user}", game);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"Updated status for {game.name} to {newStatus}", Severity.Success);
                await OnInitializedAsync(); // Refresh the data
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error updating status: {error}");
                Snackbar.Add("Failed to update game status", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating game status: {ex.Message}");
            Snackbar.Add("Error updating game status", Severity.Error);
        }
    }
}