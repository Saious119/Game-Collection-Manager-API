@page "/"
@using GameCollectionManager.Client.Shared
@using GameCollectionManager.Shared.Models
@using static MudBlazor.CategoryTypes
@using System.Net.Http.Json
@using Newtonsoft.Json
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Game Collection</PageTitle>

<MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
    <MudTabPanel Text="Games">
        <MudDataGrid Items="@games" Dense="true" Hover="true" Bordered="true" Striped="true">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Games Collection</MudText>
                <MudSpacer />
                <MudButton Color="Color.Primary" 
                          Variant="Variant.Filled" 
                          OnClick="OpenAddGameDialog" 
                          StartIcon="@Icons.Material.Filled.Add">
                    Add Game
                </MudButton>
                <MudTextField @bind-Value="searchString" Placeholder="Search" 
                            Adornment="Adornment.Start"
                            AdornmentIcon="@Icons.Material.Filled.Search" 
                            IconSize="Size.Medium" 
                            Class="mt-0 ml-4" />
            </ToolBarContent>
            <Columns>
				<PropertyColumn Property="x => x.name" Title="Title" />
                <PropertyColumn Property="x => GetFirstPlatformName(x)" Title="Platform" />
                <PropertyColumn Property="x => GetFirstReleaseDate(x)" Title="Release Date" />
                <PropertyColumn Property="x => x.aggregatedrating" Title="Rating" />
                <PropertyColumn Property="x => x.status" Title="Status" />
                <TemplateColumn Title="Actions">
                    <CellTemplate Context="gameContext">
                        <MudButton Variant="Variant.Filled" 
                                  Color="Color.Primary" 
                                  Size="Size.Small"
                                  OnClick="@(() => AddToQueue((GameDAO)gameContext.Item))"
                                  Disabled="@(((GameDAO)gameContext.Item).queuepos != null || _processing)"
                                  Loading="@(_processingId == ((GameDAO)gameContext.Item).id)">
                            @if (_processingId == ((GameDAO)gameContext.Item).id)
                            {
                                <span>Adding...</span>
                            }
                            else if(((GameDAO)gameContext.Item).queuepos != null)
                            {
                                <span>In Queue</span>
							}
                            else
                            {
                                <span>Add to Queue</span>
                            }
                        </MudButton>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    </MudTabPanel>

    <MudTabPanel Text="Queue">
        <MudDataGrid Items="@queueGames" Dense="true" Hover="true" Bordered="true" Striped="true">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Game Queue</MudText>
                <MudSpacer />
                <MudTextField @bind-Value="queueSearchString" Placeholder="Search" 
                            Adornment="Adornment.Start"
                            AdornmentIcon="@Icons.Material.Filled.Search" 
                            IconSize="Size.Medium" 
                            Class="mt-0" />
            </ToolBarContent>
            <Columns>
                <PropertyColumn Property="x => x.queuepos" Title="#" />
                <PropertyColumn Property="x => x.name" Title="Title" />
                <PropertyColumn Property="x => GetFirstPlatformName(x)" Title="Platform" />
                <PropertyColumn Property="x => GetFirstReleaseDate(x)" Title="Release Date" />
                <PropertyColumn Property="x => x.aggregatedrating" Title="Rating" />
                <PropertyColumn Property="x => x.status" Title="Status" />
                <TemplateColumn Title="Actions">
                    <CellTemplate Context="gameContext">
                        <MudButton Variant="Variant.Filled" 
                                  Color="Color.Primary" 
                                  Size="Size.Small"
                                  OnClick="@(() => RemoveFromQueue((GameDAO)gameContext.Item))"
                                  Disabled="@(((GameDAO)gameContext.Item).queuepos == null || _processing)"
                                  Loading="@(_processingId == ((GameDAO)gameContext.Item).id)">
                            @if (_processingId == ((GameDAO)gameContext.Item).id)
                            {
                                <span>Removing...</span>
                            }
                            else
                            {
                                <span>Remove From Queue</span>
                            }
                        </MudButton>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    </MudTabPanel>
</MudTabs>

@code {
    private string searchString = "";
    private string queueSearchString = "";
    private List<GameDAO> games = new();
    private List<GameDAO> queueGames = new();
    private bool _processing = false;
    private int _processingId = -1;

    private string user = "test";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await Http.GetStringAsync($"api/GameCollection/GetCollection/{user}");

            if (!string.IsNullOrEmpty(response))
            {
                try
                {

                    games = JsonConvert.DeserializeObject<List<GameDAO>>(response) ?? new();
                    queueGames = games.Where(g => g.queuepos != null)
                                    .OrderBy(g => g.queuepos)
                                    .ToList();
                }
                catch (JsonException jsonEx)
                {
                    Console.WriteLine($"JSON Deserialization error: {jsonEx.Message}");
                    Console.WriteLine($"Response content: {response}");
                }
            }
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"HTTP Request error: {ex.Message}");
            games = new();
            queueGames = new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading games: {ex.Message}");
            games = new();
            queueGames = new();
        }
    }

    // Add methods for CRUD operations
    private async Task AddGame(GameDAO game)
    {
        try
        {
			game.owner = user;
            var response = await Http.PostAsJsonAsync($"api/GameCollection/AddNewGame?user={user}", game);
            if (response.IsSuccessStatusCode)
            {
                await OnInitializedAsync();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error response: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding game: {ex.Message}");
        }
    }

    private async Task DeleteGame(GameDAO game)
    {
        try
        {
            var response = await Http.PostAsJsonAsync($"api/GameCollection/DeleteGame?user={user}", game);
            if (response.IsSuccessStatusCode)
            {
                await OnInitializedAsync();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error response: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting game: {ex.Message}");
        }
    }


    private async Task AddToQueue(GameDAO game)
    {
        try
        {
            _processing = true;
            _processingId = game.id;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync($"api/GameCollection/AddToQueue?user={user}", game);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"{game.name} added to queue", Severity.Success);
                await OnInitializedAsync();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error response: {error}");
                Snackbar.Add($"Failed to add {game.name} to queue", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding game to queue: {ex.Message}");
            Snackbar.Add($"Error adding game to queue: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
            _processingId = -1;
            StateHasChanged();
        }
    }

    private async Task RemoveFromQueue(GameDAO game)
    {
        try
        {
            _processing = true;
            _processingId = game.id;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync($"api/GameCollection/RemoveFromQueue?user={user}", game);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"{game.name} Removed from queue", Severity.Success);
                await OnInitializedAsync();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error response: {error}");
                Snackbar.Add($"Failed to remove {game.name} from queue", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error removing from queue: {ex.Message}");
            Snackbar.Add($"Error removing game from queue: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
            _processingId = -1;
            StateHasChanged();
        }
    }

    private async Task OpenAddGameDialog()
    {
        try
        {
            var parameters = new DialogParameters();
            var dialog = await DialogService.ShowAsync<AddGameDialog>("Add New Game", parameters);
            var result = await dialog.Result;
            
            if (!result.Canceled)
            {
                Console.WriteLine($"Dialog result: {JsonConvert.SerializeObject(result.Data)}");
                if (result.Data is GameDAO gameDao)
                {
                    await AddGame(gameDao);
                    Snackbar.Add($"Added {gameDao.name} to collection", Severity.Success);
                }
                else
                {
                    Console.WriteLine($"Unexpected data type: {result.Data?.GetType().FullName}");
                    Snackbar.Add("Error: Invalid game data received", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in OpenAddGameDialog: {ex}");
            Snackbar.Add("Error adding game", Severity.Error);
        }
    }

    // Helper method to safely get the first platform as string
    private string GetFirstPlatformName(GameDAO game)
    {
        try
        {
            string gameAsText = JsonConvert.SerializeObject(game);
            Console.WriteLine(gameAsText);
            return game?.platforms ?? string.Empty;
        }
        catch
        {
            return string.Empty;
        }
    }

    private string GetFirstReleaseDate(GameDAO game)
    {
        try
        {
            return game?.releasedates ?? string.Empty;
        }
        catch
        {
            return string.Empty;
        }
    }
}